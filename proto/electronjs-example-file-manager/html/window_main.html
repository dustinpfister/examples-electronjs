<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>File Manager</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div id="wrap_main">
        <br><br>
        <div id="toolbar">
           <input id="input_pwd" type="text" size="60"><br><br>
           <input id="input_runterm" type="button" value="Terminal">
        </div>
        <br></br>
        <div id="contents_pwd">
        </div>
    </div>
    <script>
//-------- ----------
// HELPERS
//-------- ----------
// set style of a single div
const setDivStyle = (state, itemData, selectedState, div) => {
    // get div and update style
    div = div || document.getElementById('item_' + itemData[3]);
    // if folder
    if(itemData[1] && selectedState){
        div.className = 'contents_item contents_item_folder_selected';
    }
    // if file
    if(!itemData[1] && selectedState){
        div.className = 'contents_item contents_item_file_selected';
    }
    // if folder
    if(itemData[1] && !selectedState){
        div.className = 'contents_item contents_item_folder';
    }
    // if file
    if(!itemData[1] && !selectedState){
        div.className = 'contents_item contents_item_file';
    }
};
// set style for all selcted divs
const setSelectedDivStyle = (state, selectedState ) => {

    state.selected.forEach( ( itemIndex ) => {
        const itemData = state.files[itemIndex];
        setDivStyle(state, itemData, selectedState);
    });

};

// event hander for items
const createItemClickHandler = (state, itemData) => {
    return (e) => {
        const i = itemData[3];
        // if NOT CTRL, AND state.selcted.length is one, AND current item is selected item
        if(!state.CTRL && state.selected.length === 1 && state.files[ state.selected[0] ][3] === i ){
            // if selected item is a folder
            if(itemData[1]){
                setPWD(state, itemData[2]);
            }
            setSelectedDivStyle(state, false);
            state.selected = [];
            return;
        }
        // if NOT CTRL, result selected array at this point
        if(!state.CTRL){
            setSelectedDivStyle(state, false);
            state.selected = [];
        }
        // push index to selcted array
        state.selected.push(i);
        setDivStyle(state, itemData, true);

        console.log(state.selected);
    };
};
// update contents with given files array
const createListContents = (state, files, el) => {
    // for each file
    const items = files.map( (itemData) => {
        const div = document.createElement('p');
        div.className = 'contents_item';
        div.id = 'item_' + itemData[3];
        div.addEventListener('pointerup', createItemClickHandler(state, itemData ) );

        setDivStyle(state, itemData, false, div);

        // if folder
        //if(itemData[1]){
        //     div.className = 'contents_item contents_item_folder';
        //}
        // if file
        //if(!itemData[1]){
        //     div.className = 'contents_item contents_item_file';
        //}
        div.innerText = itemData[0];
        return div;
    });
    el.replaceChildren(...items);
    // all not selected for starters
};
// set the current pwd
const setPWD = (state, pwd) => {
    state.pwd = pwd;
    // using realpath to convert ~ to /home/currentuser
    return fm.run('realpath ' + state.pwd)
    .then((result)=>{
        state.pwd = result.trim();
        return fm.readdir(state.pwd);
    })
    // get files array from fm api and update state.files
   .then((files)=>{
        state.files = files;
        // SORT FOLDERS ABOVE FILES
        state.files.sort(function(itemA, itemB){
            if(itemA[1] && !itemB[1]){
                return -1;
            }
            return 1;
        });
        // UPDATE INDEX VALUES AS THEY HAVE BEEN SORTED
        state.files = state.files.map((item, i)=>{
             item[3] = i;
             return item;
        });
        // create the list with the whole contents of state.files
        createListContents(state, state.files, state.el_contents_pwd);
        state.el_input_pwd.value = state.pwd;
   });
};
//-------- ----------
// STATE OBJECT
//-------- ----------
const state = {
    pwd: '~/Documents',
    files: [],
    CTRL: false,
    selected: [], // an array of currentlt selected index values of items in state.files
    el_contents_pwd : document.getElementById('contents_pwd'),
    el_input_pwd : document.getElementById('input_pwd'),
    el_runterm : document.getElementById('input_runterm')
};
//-------- ----------
// SETUP
//-------- ----------
setPWD(state, state.pwd);
//-------- ----------
// INPUT_PWD
//-------- ----------
state.el_input_pwd.addEventListener('change', (e)=> {
    setPWD(state, e.target.value);
});
//-------- ----------
// INPUT_RUNTERM
//-------- ----------
state.el_runterm.addEventListener('click', (e)=> {
    fm.run('lxterminal --working-directory=\"'+ state.pwd +'\"');
});
    </script>
  </body>
</html>