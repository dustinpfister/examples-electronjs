<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>File Manager</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div id="wrap_main">
        <br><br>
        <div id="toolbar">
           <input id="input_pwd" type="text" size="60"><br><br>
           <input id="input_runterm" type="button" value="Terminal">
        </div>
        <br></br>
        <div id="contents_pwd">
        </div>
    </div>
    <script>
//-------- ----------
// HELPERS
//-------- ----------
const createFolderClickHandler = (state, itemData) => {
    return (e) => {
        setPWD(state, itemData[2]);
    };
};
// update contents with given files array
const createListContents = (state, files, el) => {
    // for each file
    const items = files.map( (itemData) => {
        const div = document.createElement('p');
        div.className = 'contents_item';
        // if folder
        if(itemData[1]){
             div.className = 'contents_item contents_item_folder';
             
             div.addEventListener('pointerup', createFolderClickHandler(state, itemData ) );
        }
        div.innerText = itemData[0];
        return div;
    });
    el.replaceChildren(...items);
};
// set the current pwd
const setPWD = (state, pwd) => {
    state.pwd = pwd;
    // using realpath to convert ~ to /home/currentuser
    return fm.run('realpath ' + state.pwd)
    .then((result)=>{
        state.pwd = result.trim();
        return fm.readdir(state.pwd);
    })
    // get files array from fm api
   .then((files)=>{
        // SORT FOLDERS ABOVE FILES
        files.sort(function(itemA, itemB){
            if(itemA[1] && !itemB[1]){
                return -1;
            }
            return 1;
        });
        // create the list and update value
        createListContents(state, files, state.el_contents_pwd);
        state.el_input_pwd.value = state.pwd;
   });
};
//-------- ----------
// STATE OBJECT
//-------- ----------
const state = {};
// start at root for now
state.pwd = "~/Documents";
state.el_contents_pwd = document.getElementById('contents_pwd');
state.el_input_pwd = document.getElementById('input_pwd');
state.el_runterm = document.getElementById('input_runterm');
//-------- ----------
// SETUP
//-------- ----------
setPWD(state, state.pwd);
//-------- ----------
// INPUT_PWD
//-------- ----------
state.el_input_pwd.addEventListener('change', (e)=> {
    setPWD(state, e.target.value);
});
//-------- ----------
// INPUT_RUNTERM
//-------- ----------
state.el_runterm.addEventListener('click', (e)=> {
    fm.run('lxterminal --working-directory=\"'+ state.pwd +'\"');
});
    </script>
  </body>
</html>